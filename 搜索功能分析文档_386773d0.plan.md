---
name: 搜索功能分析文档
overview: 分析现有搜索和高级搜索功能的实现，总结现有功能，识别不合理之处，并提出优化改进建议。
todos:
  - id: doc-current-features
    content: 整理现有搜索功能文档
    status: pending
  - id: doc-issues
    content: 记录功能不合理之处
    status: pending
  - id: doc-suggestions
    content: 提出优化改进建议
    status: pending
---

# 搜索功能分析与优化建议

## 一、现有功能概述

### 1.1 普通搜索 (`src/features/search/utils/filter.js`)

| 特性 | 描述 |
|------|------|
| 搜索方式 | 单关键词全字段模糊匹配 |
| 搜索范围 | title, brand, category, supplier, grade, issue, price, currentBid, qty, countdown |
| 大小写 | 不区分大小写 |
| 触发方式 | 实时搜索（使用 useDeferredValue 优化） |

### 1.2 高级搜索

**核心文件:**
- `src/features/search/components/AdvancedSearch.jsx` - 主面板组件
- `src/features/search/components/ConditionRow.jsx` - 单个条件行
- `src/features/search/components/SavedSearchTags.jsx` - 已保存策略标签
- `src/features/search/hooks/useAdvancedSearch.js` - 状态管理
- `src/features/search/utils/advancedFilter.js` - 过滤逻辑
- `src/features/search/constants/searchFields.js` - 字段与操作符配置

**可搜索字段 (9个):**
| 字段 | 类型 | 操作符 |
|------|------|--------|
| 商品名称 | text | 包含、不包含、等于、开头是 |
| 品牌 | text | 包含、不包含、等于、开头是 |
| 品类 | text | 包含、不包含、等于、开头是 |
| 供应商 | select | 等于、不等于 |
| 成色 | select | 等于、不等于 |
| 问题 | text | 包含、不包含、等于、开头是 |
| 参考价 | number | 等于、大于、大于等于、小于、小于等于 |
| 数量 | number | 等于、大于、大于等于、小于、小于等于 |
| 已出价 | number | 等于、大于、大于等于、小于、小于等于 |

**搜索策略管理:**
- 命名保存当前搜索条件
- 标签快速加载
- 编辑/另存为/删除策略
- 本地存储持久化

**逻辑特性:**
- 多条件 **AND** 组合（必须同时满足所有条件）
- 空值条件自动跳过
- 实时显示匹配数量

---

## 二、不合理之处与优化建议

### 2.1 功能层面

| 问题 | 严重程度 | 优化建议 |
|------|----------|----------|
| **只支持 AND 逻辑** | 高 | 增加 OR 逻辑支持，允许用户选择条件间关系 |
| **普通搜索与高级搜索互斥** | 中 | 允许两者联合使用，或将普通搜索作为高级搜索的一个快捷条件 |
| **缺少"结尾是"操作符** | 低 | 为文本类型添加 `endsWith` 操作符 |
| **缺少"为空/不为空"操作符** | 中 | 添加 `isEmpty` 和 `isNotEmpty` 操作符，便于筛选缺失数据 |
| **数字类型缺少"不等于"** | 低 | 为 number 类型添加 `notEquals` 操作符 |
| **缺少搜索历史** | 低 | 记录最近 10 条搜索记录，支持快速重用 |
| **缺少搜索结果高亮** | 中 | 在表格中高亮显示匹配的关键词 |

### 2.2 交互层面

| 问题 | 严重程度 | 优化建议 |
|------|----------|----------|
| **SavedSearchTags 无删除按钮** | 中 | 在标签上添加 closable 属性，支持快速删除 |
| **标签不显示匹配数量** | 低 | 在标签悬浮时显示该策略匹配的记录数 |
| **条件无法拖拽排序** | 低 | 支持拖拽调整条件顺序 |
| **输入框宽度固定** | 低 | 根据字段类型动态调整宽度，或使用 autoSize |
| **缺少自动完成** | 中 | 为文本字段提供基于现有数据的建议值 |
| **新建默认条件不灵活** | 低 | 记住用户上次使用的字段作为默认 |

### 2.3 代码/性能层面

| 问题 | 严重程度 | 优化建议 |
|------|----------|----------|
| **前端过滤性能瓶颈** | 高 | 数据量大时应迁移到后端过滤，支持分页 |
| **JSON.stringify 比较 dirty** | 低 | 使用 lodash 的 isEqual 或实现专用比较函数 |
| **多处深拷贝代码重复** | 低 | 抽取为工具函数，使用 structuredClone 或 lodash |
| **成色 options 硬编码空数组** | 低 | 从常量或配置统一管理 |

---

## 三、优先级排序的改进需求

### P0 (建议优先处理)
1. 增加 OR 逻辑支持
2. SavedSearchTags 添加删除功能

### P1 (重要改进)
1. 添加"为空/不为空"操作符
2. 搜索结果高亮
3. 文本字段自动完成建议

### P2 (体验优化)
1. 普通搜索与高级搜索联合使用
2. 搜索历史记录
3. 标签悬浮显示匹配数
4. 条件拖拽排序

### P3 (技术债务)
1. 性能优化（后端过滤）
2. 代码重构（深拷贝函数抽取）

---

## 四、过滤逻辑流程图

```
原始数据
    ↓
[普通搜索过滤] → searchFiltered
    ↓
[高级搜索过滤] → advancedFiltered (AND 逻辑)
    ↓
[供应商过滤] → supplierFiltered
    ↓
[成色过滤] → gradeFiltered (多选)
    ↓
[出价状态过滤] → bidFiltered
    ↓
[只看关注过滤] → followFilteredData
    ↓
最终展示数据
```

---

## 五、相关文件清单

| 文件路径 | 职责 |
|----------|------|
| `src/features/search/index.js` | 模块统一导出 |
| `src/features/search/components/AdvancedSearch.jsx` | 高级搜索面板 |
| `src/features/search/components/ConditionRow.jsx` | 单个搜索条件行 |
| `src/features/search/components/SavedSearchTags.jsx` | 已保存策略标签 |
| `src/features/search/hooks/useAdvancedSearch.js` | 高级搜索状态管理 |
| `src/features/search/utils/filter.js` | 普通搜索过滤 |
| `src/features/search/utils/advancedFilter.js` | 高级搜索过滤 |
| `src/features/search/constants/searchFields.js` | 字段与操作符配置 |
| `src/hooks/useAuctionFilters.js` | 组合过滤逻辑 |
| `src/components/TableToolbar.jsx` | 工具栏（集成搜索） |
| `src/pages/ListPage.jsx` | 列表页（使用搜索） |
| `src/services/storageService.js` | 本地存储服务 |
